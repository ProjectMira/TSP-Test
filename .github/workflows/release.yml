name: Full Release (Android + iOS)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      android_track:
        description: 'Android release track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
      ios_submit_review:
        description: 'Submit iOS for App Store review'
        required: true
        default: false
        type: boolean

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  # ============================================
  # ANDROID BUILD & RELEASE
  # ============================================
  android:
    name: Build & Release Android
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: tsp_tibetan_test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

      - name: Create key.properties
        run: |
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=upload-keystore.jks
          EOF

      - name: Get version
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
          VERSION_NAME=$(echo $VERSION | cut -d'+' -f1)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT

      - name: Build App Bundle
        run: |
          flutter build appbundle \
            --release \
            --build-name=${{ steps.version.outputs.version_name }} \
            --build-number=${{ github.run_number }}

      - name: Build APK
        run: |
          flutter build apk \
            --release \
            --build-name=${{ steps.version.outputs.version_name }} \
            --build-number=${{ github.run_number }}

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: |
            tsp_tibetan_test/build/app/outputs/bundle/release/app-release.aab
            tsp_tibetan_test/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 14

      - name: Upload to Google Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.example.past_papers_app
          releaseFiles: tsp_tibetan_test/build/app/outputs/bundle/release/app-release.aab
          track: ${{ github.event.inputs.android_track || 'internal' }}
          status: completed

  # ============================================
  # iOS BUILD & RELEASE
  # ============================================
  ios:
    name: Build & Release iOS
    runs-on: macos-latest
    defaults:
      run:
        working-directory: tsp_tibetan_test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update

      - name: Install Apple Certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Install Provisioning Profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      - name: Get version
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
          VERSION_NAME=$(echo $VERSION | cut -d'+' -f1)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT

      - name: Create ExportOptions.plist
        run: |
          cat > ios/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.APPLE_TEAM_ID }}</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>signingStyle</key>
              <string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>${{ secrets.IOS_BUNDLE_ID }}</key>
                  <string>${{ secrets.APPLE_PROVISIONING_PROFILE_NAME }}</string>
              </dict>
          </dict>
          </plist>
          EOF

      - name: Build iOS App
        run: |
          flutter build ipa \
            --release \
            --build-name=${{ steps.version.outputs.version_name }} \
            --build-number=${{ github.run_number }} \
            --export-options-plist=ios/ExportOptions.plist

      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-release
          path: tsp_tibetan_test/build/ios/ipa/*.ipa
          retention-days: 14

      - name: Upload to App Store Connect
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8
          
          IPA_PATH=$(find build/ios/ipa -name "*.ipa" | head -1)
          
          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_API_ISSUER_ID"

      - name: Submit for App Store Review
        if: ${{ github.event.inputs.ios_submit_review == 'true' }}
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
        run: |
          gem install fastlane
          mkdir -p fastlane
          
          cat > fastlane/Appfile << EOF
          app_identifier("$IOS_BUNDLE_ID")
          EOF
          
          cat > fastlane/Fastfile << 'FASTFILE'
          default_platform(:ios)
          
          platform :ios do
            lane :submit_review do
              app_store_connect_api_key(
                key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
                issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
                key_filepath: File.expand_path("~/.appstoreconnect/private_keys/AuthKey_#{ENV['APP_STORE_CONNECT_API_KEY_ID']}.p8"),
                in_house: false
              )
              
              deliver(
                submit_for_review: true,
                automatic_release: false,
                force: true,
                skip_metadata: true,
                skip_screenshots: true,
                skip_binary_upload: true,
                precheck_include_in_app_purchases: false
              )
            end
          end
          FASTFILE
          
          cd ios && fastlane submit_review

      - name: Cleanup
        if: always()
        run: |
          rm -f ios/ExportOptions.plist
          rm -rf ~/.appstoreconnect
          rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

  # ============================================
  # CREATE GITHUB RELEASE
  # ============================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [android, ios]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION=$(grep 'version:' tsp_tibetan_test/pubspec.yaml | sed 's/version: //')
          VERSION_NAME=$(echo $VERSION | cut -d'+' -f1)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT

      - name: Download Android Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-release
          path: android-artifacts

      - name: Download iOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-release
          path: ios-artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version_name }}-${{ github.run_number }}
          files: |
            android-artifacts/**/*
            ios-artifacts/**/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

