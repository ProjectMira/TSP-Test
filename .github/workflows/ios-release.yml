name: iOS Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      submit_for_review:
        description: 'Submit for App Store review after upload'
        required: true
        default: false
        type: boolean

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  build-and-release:
    name: Build and Release iOS
    runs-on: macos-latest
    defaults:
      run:
        working-directory: tsp_tibetan_test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      # Install CocoaPods dependencies
      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update

      # Install Apple certificates and provisioning profiles
      - name: Install Apple Certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      # Decode and install provisioning profile
      - name: Install Provisioning Profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      # Extract version from pubspec.yaml
      - name: Get version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
          VERSION_NAME=$(echo $VERSION | cut -d'+' -f1)
          VERSION_CODE=$(echo $VERSION | cut -d'+' -f2)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT

      # Create ExportOptions.plist for archive export
      - name: Create ExportOptions.plist
        run: |
          cat > ios/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.APPLE_TEAM_ID }}</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>signingStyle</key>
              <string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>${{ secrets.IOS_BUNDLE_ID }}</key>
                  <string>${{ secrets.APPLE_PROVISIONING_PROFILE_NAME }}</string>
              </dict>
          </dict>
          </plist>
          EOF

      # Build iOS app (release)
      - name: Build iOS App
        run: |
          flutter build ipa \
            --release \
            --build-name=${{ steps.version.outputs.version_name }} \
            --build-number=${{ github.run_number }} \
            --export-options-plist=ios/ExportOptions.plist

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-ipa
          path: tsp_tibetan_test/build/ios/ipa/*.ipa
          retention-days: 14

      # Upload to App Store Connect using Fastlane
      - name: Upload to App Store Connect
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          # Decode API key
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8
          
          # Find the IPA file
          IPA_PATH=$(find build/ios/ipa -name "*.ipa" | head -1)
          
          # Upload using xcrun altool (or use Fastlane)
          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_API_ISSUER_ID"

      # Optional: Submit for review automatically
      - name: Submit for App Store Review
        if: ${{ github.event.inputs.submit_for_review == 'true' }}
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
        run: |
          # Install Fastlane for submission
          gem install fastlane
          
          # Create Fastlane directory and config
          mkdir -p fastlane
          
          # Create Appfile
          cat > fastlane/Appfile << EOF
          app_identifier("$IOS_BUNDLE_ID")
          EOF
          
          # Create minimal Fastfile for submission
          cat > fastlane/Fastfile << 'FASTFILE'
          default_platform(:ios)
          
          platform :ios do
            desc "Submit for App Store review"
            lane :submit_review do
              app_store_connect_api_key(
                key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
                issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
                key_filepath: File.expand_path("~/.appstoreconnect/private_keys/AuthKey_#{ENV['APP_STORE_CONNECT_API_KEY_ID']}.p8"),
                in_house: false
              )
              
              deliver(
                submit_for_review: true,
                automatic_release: false,
                force: true,
                skip_metadata: true,
                skip_screenshots: true,
                skip_binary_upload: true,
                precheck_include_in_app_purchases: false
              )
            end
          end
          FASTFILE
          
          # Run submission
          cd ios && fastlane submit_review

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version_name }}-${{ github.run_number }}
          files: tsp_tibetan_test/build/ios/ipa/*.ipa
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Clean up sensitive files
      - name: Cleanup
        if: always()
        run: |
          rm -f ios/ExportOptions.plist
          rm -rf ~/.appstoreconnect
          rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

